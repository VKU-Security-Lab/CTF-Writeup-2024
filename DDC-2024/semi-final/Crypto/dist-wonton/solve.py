import math
from math import gcd
import random
from Crypto.Util.number import long_to_bytes

def factor_n(e, d, n):
    k = e * d - 1
    # Phân tích k thành 2^s * t
    s = 0
    while k % 2 == 0:
        k //= 2
        s += 1
    t = k

    for _ in range(100):  # Số lần thử tối đa
        a = random.randint(2, n - 1)
        x = pow(a, t, n)
        if x == 1 or x == n -1:
            continue
        for _ in range(s):
            y = pow(x, 2, n)
            if y == 1:
                p = gcd(x -1, n)
                q = n // p
                return p, q
            if y == n -1:
                break
            x = y
    raise Exception("Không thể phân tích n")

# Các thông số từ out.txt
e = 65537
d = 11104012999836174730756002235665976183159876779084997801485779477565805210334358611561689522759772083449375028393701082967330945714435079891472885927608547166765267982141599159557126633999735116275942968600985062240930674550952665638332975051568142112239097174155483981899740502650254486802690098351060007813
c = 22901231112172133921223023279932848644955468094189943499578909198019077221924833200565673189376253713488688464220048897712120515832982702942290897075289971346156577914219185742348240953225147347048438364584574006395759857925164450267599965997307882299205421296903039480790759546170709029003277455548971450350
n = 58493987619183617340210282012606790540611594282685756845589062745858867942262105966234100655341787881442142210098704917163408744416600902728676032878199626884130417152696885610374378019731470282804599072068908299895512483158711696105516436984751805641649115163723043599171244465850342932433816420742930825017

# Phân tích n để tìm p và q
p, q = factor_n(e, d, n)
print(f'p = {p}')
print(f'q = {q}')

# Chuyển đổi q về dạng byte
q_bytes = long_to_bytes(q)
# Giả định rằng flag nằm ở đầu và 26 byte cuối là ngẫu nhiên
flag_bytes = q_bytes[:-26]  # Loại bỏ 26 byte cuối
try:
    flag = flag_bytes.decode()
    print(f'Flag: {flag}')
except UnicodeDecodeError:
    print("Không thể giải mã flag. Kiểm tra lại định dạng của q.")
